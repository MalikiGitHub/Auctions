{% extends "auctions/layout.html" %}
{% load static %}
{% block body %}
    <h2>Active Listings</h2>
    <div class="container text-center">
        {% if page_obj %}
        {% for listing in page_obj %}
        <div class="row align-items-start pb-3 mb-3 border-bottom">
            <div class="col">
                {% if listing.image %}
                <img src="{{ listing.image.url }}" alt="Image for {{ listing.title }}" style="max-width:200px; max-height:200px;">
                {% else %}
                <p>No image available</p>
                {% endif %}
            </div>
            <div class="col">
                <p class="font-weight-bold"><a href="{% url 'listing_detail' listing.id %}">{{ listing.title }}</a></p>
                <p class="font-weight-bold">Price: ${{ listing.current_price }}</p>
                <p class="font-weight-bold">Category: {{ listing.category.name|default:"Uncategorized" }}</p>
                <p class="text-muted">Posted: {{ listing.created_date|date:"M j, Y. g.iA"|lower }}</p>
                <p>Owner: {{ listing.owner.username }}</p>

                <p class="font-weight-bold">Auction Winner: {{ listing.close_auction }}</p>
            </div>
            <div class="col">
                <button class="watchlist-btn btn {% if user in listing.watchlist.all %}btn-warning{% else %}btn-outline-warning{% endif %}"
                        data-listing-id="{{ listing.id }}" 
                        data-url="{% url 'toggle_watchlist' listing.id %}">
                    {% if user in listing.watchlist.all %}
                        ‚òÖ Remove from Watchlist
                    {% else %}
                        ‚òÜ Add to Watchlist
                    {% endif %}
                </button>
                
                <div class="watchlist-message mt-2"></div>
                 <!-- DELETE BUTTON - Only show to listing owner -->
                {% if user == listing.owner %}
                    <div class="mt-3">
                        <form method="post" action="{% url 'delete_listing' listing.id %}" class="delete-form d-inline" data-listing-id="{{ listing.id }}">
                            {% csrf_token %}
                            <button type="button" class="btn btn-danger delete-btn" data-listing-id="{{ listing.id }}" data-name="{{ listing.title }}">
                                üóëÔ∏è Delete Listing
                            </button>
                        </form>
                        <div class="delete-message mt-2"></div>
                    </div>
                {% endif %}
                <!-- END DELETE BUTTON -->
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p> No listings available. </p>
    {% endif %}

    <div class="pagination">
        <span class="page-links">
            {% if page_obj.has_previous %}
                <a href="?page=1">&laquo; first</a>
                <a href="?page={{ page_obj.previous_page_number }}">previous</a>
            {% endif %}

            <span class="current">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
            {% endif %}
        </span>
    </div>

    <script>
        // Update the function to accept listing ID
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to all delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const listingId = this.getAttribute('data-listing-id');
                    const listingName = this.getAttribute('data-name');
                    console.log('Delete button clicked for listing ID:', listingId);
                    
                    Swal.fire({
                        title: 'Permanent Deletion!',
                        text: "This will PERMANENTLY delete listing " + listingName + " and all associated bids. This action cannot be undone!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Yes, delete permanently!',
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Show loading state
                            const button = this;
                            const originalText = button.innerHTML;
                            button.innerHTML = '‚è≥ Deleting...';
                            button.disabled = true;

                            // Find and submit the form
                            const form = button.closest('.delete-form');
                            form.submit();
                        }
                    });
                });
            });
        });

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.watchlist-btn').forEach(button => {
            button.addEventListener('click', function() {
                const listingId = this.dataset.listingId;
                const url = this.dataset.url;
                console.log('Toggling watchlist for listing ID:', listingId);
                const button = this;
                // Get the message div that's next to this button
                const messageDiv = this.nextElementSibling;
                
                // Show loading state
                button.disabled = true;
                button.innerHTML = '‚è≥ Processing...';
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response:', data);
                    
                    // Update button appearance
                    if (data.is_watchlisted) {
                        button.classList.remove('btn-outline-warning');
                        button.classList.add('btn-warning');
                        button.innerHTML = '‚òÖ Remove from Watchlist';
                    } else {
                        button.classList.remove('btn-warning');
                        button.classList.add('btn-outline-warning');
                        button.innerHTML = '‚òÜ Add to Watchlist';
                    }
                    
                    // UPDATE NAVIGATION BADGE - Add this line
                    if (typeof updateNavWatchlistCount === 'function') {
                        updateNavWatchlistCount();
                    }
                    
                    // Show message
                    messageDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    messageDiv.innerHTML = `<div class="alert alert-danger">Error updating watchlist</div>`;
                })
                .finally(() => {
                    button.disabled = false;
                });
            });
        });
    });
    </script>           
{% endblock %}